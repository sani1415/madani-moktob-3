<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï ‡¶ï‡¶∞‡ßç‡¶®‡¶æ‡¶∞ - ‡¶Æ‡¶æ‡¶¶‡¶æ‡¶®‡ßÄ ‡¶Æ‡¶ï‡ßç‡¶§‡¶¨</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* General Styles to match existing app */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif, 'Noto Sans Bengali', 'SolaimanLipi';
            background-color: #f5f5f5;
        }
        .header { background: linear-gradient(135deg, #2c3e50, #3498db); }
        .nav { background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .section h2 { color: #2c3e50; border-bottom: 3px solid #3498db; }
        .btn-primary { background-color: #3498db; } .btn-primary:hover { background-color: #2980b9; }
        .btn-secondary { background-color: #6c757d; } .btn-secondary:hover { background-color: #5a6268; }
        .btn-success { background-color: #27ae60; } .btn-success:hover { background-color: #229554; }
        .btn-danger { background-color: #e74c3c; } .btn-danger:hover { background-color: #c0392b; }

        /* Teacher's Corner Specific Styles */
        .nav-item.dropdown .dropdown-menu { display: none; position: absolute; background-color: white; min-width: 200px; box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2); z-index: 101; border-radius: 0 0 8px 8px; }
        .nav-item.dropdown:hover .dropdown-menu { display: block; }
        .dropdown-item { color: #333; padding: 12px 16px; text-decoration: none; display: block; transition: background-color 0.2s; }
        .dropdown-item:hover { background-color: #f1f1f1; }
        .stat-card { background: white; padding: 25px 15px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.07); text-align: center; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .logbook-tabs button.active { border-bottom: 2px solid #3498db; color: #3498db; }
        .log-entry { border-left: 4px solid #3498db; transition: background-color 0.2s; }
        .log-entry:hover { background-color: #f0f4f8; }
        .log-entry .log-actions { opacity: 0; transition: opacity 0.2s; }
        .log-entry:hover .log-actions { opacity: 1; }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 200; animation: fadeIn 0.3s; }
        .modal-content { animation: slideIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .score-badge {
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 12px;
            color: white;
            font-size: 12px;
            cursor: pointer;
        }
        .score-good { background-color: #27ae60; }
        .score-average { background-color: #f39c12; }
        .score-attention { background-color: #e74c3c; }
        
        /* Performance optimizations */
        .student-list-container {
            contain: layout;
        }
        
        .modal-backdrop {
            contain: layout style paint;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header & Navigation (Same as before) -->
    <header class="header text-white p-5 shadow-md">
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold"><i class="fas fa-graduation-cap"></i> ‡¶Æ‡¶æ‡¶¶‡¶æ‡¶®‡ßÄ ‡¶Æ‡¶ï‡ßç‡¶§‡¶¨</h1>
        </div>
    </header>
    <nav class="nav">
        <div class="container mx-auto">
            <ul class="flex justify-center items-center list-none">
                <li class="nav-item"><a href="#" onclick="showSection('main-dashboard')" class="nav-link block px-6 py-4 text-gray-600 hover:text-blue-500">‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</a></li>
                <li class="nav-item dropdown relative">
                    <a href="#" class="nav-link block px-6 py-4 text-gray-600 hover:text-blue-500 font-semibold"><i class="fas fa-chalkboard-teacher"></i> ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï ‡¶ï‡¶∞‡ßç‡¶®‡¶æ‡¶∞ <i class="fas fa-chevron-down text-xs ml-1"></i></a>
                    <div id="teachers-corner-dropdown" class="dropdown-menu"></div>
                </li>
                <li class="nav-item"><a href="#" class="nav-link block px-6 py-4 text-gray-600 hover:text-blue-500">‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶®</a></li>
                <li class="nav-item"><a href="#" class="nav-link block px-6 py-4 text-gray-600 hover:text-blue-500">‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶â‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto p-4 md:p-6">


        <section id="teachers-corner-section" class="section">
            <h2 id="class-dashboard-title" class="text-2xl font-bold mb-6 pb-2"></h2>

            <!-- Today's Summary -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="stat-card"><i class="fas fa-users text-4xl text-blue-500 mb-4"></i><h3 id="class-total-students" class="text-4xl font-bold text-gray-800">0</h3><p class="text-gray-500">‡¶Æ‡ßã‡¶ü ‡¶õ‡¶æ‡¶§‡ßç‡¶∞</p></div>
                <div class="stat-card"><i class="fas fa-user-check text-4xl text-green-500 mb-4"></i><h3 id="class-present-today" class="text-4xl font-bold text-gray-800">0</h3><p class="text-gray-500">‡¶Ü‡¶ú ‡¶â‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§</p></div>
                <div class="stat-card"><i class="fas fa-user-times text-4xl text-red-500 mb-4"></i><h3 id="class-absent-today" class="text-4xl font-bold text-gray-800">0</h3><p class="text-gray-500">‡¶Ü‡¶ú ‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§</p></div>
                <div class="stat-card"><i class="fas fa-percentage text-4xl text-purple-500 mb-4"></i><h3 id="class-attendance-rate" class="text-4xl font-bold text-gray-800">0%</h3><p class="text-gray-500">‡¶â‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø‡¶∞ ‡¶π‡¶æ‡¶∞</p></div>
            </div>

            <!-- Dashboard Alerts -->
            <div id="dashboard-alerts" class="mb-8 bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4 text-gray-700 flex items-center gap-2">
                    <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                    ‡¶è‡¶ï ‡¶®‡¶ú‡¶∞‡ßá ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ
                </h3>
                <div id="alerts-content" class="space-y-3">
                    <!-- Alerts will be rendered here -->
                </div>
            </div>

            <!-- Class Overview & Teacher's Logbook -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                     <h3 class="text-xl font-semibold mb-4 text-gray-700">‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶¨‡¶ø‡¶ï ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</h3>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                   <div>
                              <h4 class="font-semibold text-gray-600 text-sm mb-2">‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶¶‡ßá‡¶∞ ‡¶∏‡ßç‡¶§‡¶∞</h4>
                              <div id="performance-chart" class="space-y-3">
                                  <!-- Performance categories will be rendered here -->
                              </div>
                          </div>
                         <div>
                             <h4 class="font-semibold text-gray-600 text-sm mb-2">‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ ‡¶≤‡¶ó</h4>
                             <div id="recent-class-logs" class="space-y-2">
                                 <!-- Recent logs will be rendered here -->
                             </div>
                         </div>
                     </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-700">üìî ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï‡ßá‡¶∞ ‡¶≤‡¶ó‡¶¨‡ßÅ‡¶ï</h3>
                        <button onclick="showAddLogModal()" class="btn-success text-white px-3 py-1 rounded-md text-sm font-semibold flex items-center gap-2"><i class="fas fa-plus"></i> ‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡ßã‡¶ü</button>
                    </div>
                    <div class="logbook-tabs border-b border-gray-200 mb-4">
                        <button onclick="switchLogTab('class')" class="tab-button py-2 px-4 text-gray-500 font-semibold active">‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ ‡¶≤‡¶ó</button>
                        <button onclick="switchLogTab('student')" class="tab-button py-2 px-4 text-gray-500 font-semibold">‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶≤‡¶ó</button>
                    </div>
                    <div id="logbook-display" class="space-y-4 max-h-[200px] overflow-y-auto pr-2"></div>
                </div>
            </div>

            <!-- Student List & Education Progress -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-700">‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶¶‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3>
                        <button onclick="clearStudentFilter()" class="text-sm text-blue-600 hover:text-blue-800 underline">
                            ‡¶∏‡¶¨ ‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®
                        </button>
                    </div>
                    <div class="max-h-96 overflow-y-auto student-list-container">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-center">‡¶π‡ßÅ‡¶∏‡¶®‡ßÅ‡¶≤ ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶ï</th>
                                    <th class="px-4 py-3">‡¶∞‡ßã‡¶≤</th>
                                    <th class="px-4 py-3">‡¶®‡¶æ‡¶Æ</th>
                                </tr>
                            </thead>
                            <tbody id="class-student-list"></tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-700">‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø</h3>
                        <div class="flex gap-2">
                            <button onclick="showBookModal()" class="text-gray-500 hover:text-blue-500" title="‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶á ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <div id="class-education-progress" class="space-y-4"></div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modals -->
    <div id="log-modal" class="modal-backdrop justify-center items-center">
        <div class="modal-content bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3">
            <div class="p-6 border-b"><h3 id="log-modal-title" class="text-xl font-semibold text-gray-800"></h3></div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="log-id"><input type="hidden" id="log-class-name"><input type="hidden" id="log-student-id">
                <div><label for="log-type" class="block text-sm font-medium text-gray-700 mb-1">‡¶®‡ßã‡¶ü‡ßá‡¶∞ ‡¶ß‡¶∞‡¶£</label><select id="log-type" class="w-full border-gray-300 rounded-md shadow-sm"><option value="‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶Æ‡ßÇ‡¶≤‡¶ï">‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶Æ‡ßÇ‡¶≤‡¶ï</option><option value="‡¶Ü‡¶ö‡¶∞‡¶£‡¶ó‡¶§">‡¶Ü‡¶ö‡¶∞‡¶£‡¶ó‡¶§</option><option value="‡¶™‡¶ø‡¶§‡¶æ‡¶Æ‡¶æ‡¶§‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó">‡¶™‡¶ø‡¶§‡¶æ‡¶Æ‡¶æ‡¶§‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó</option><option value="‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶ò‡¶ü‡¶®‡¶æ">‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶ò‡¶ü‡¶®‡¶æ</option><option value="‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£">‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£</option></select></div>
                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="log-important" class="rounded">
                        <span class="text-sm font-medium text-gray-700">‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="log-followup" class="rounded">
                        <span class="text-sm font-medium text-gray-700">‡¶Ö‡¶®‡ßÅ‡¶∏‡¶∞‡¶£ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®</span>
                    </label>
                </div>
                <div><label for="log-details" class="block text-sm font-medium text-gray-700 mb-1">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</label><textarea id="log-details" rows="4" class="w-full border-gray-300 rounded-md shadow-sm" placeholder="‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶®‡ßã‡¶ü ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea></div>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-end gap-3"><button onclick="closeLogModal()" class="btn-secondary text-white px-4 py-2 rounded-md">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button><button onclick="saveLogEntry()" class="btn-primary text-white px-4 py-2 rounded-md">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£</button></div>
        </div>
    </div>
    <div id="student-profile-modal" class="modal-backdrop justify-center items-center">
        <div class="modal-content bg-white rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2">
             <div class="p-6 border-b flex justify-between items-center">
                <h3 id="student-profile-title" class="text-xl font-semibold text-gray-800"></h3>
                <div>
                    <button onclick="printStudentProfile()" class="text-gray-600 hover:text-blue-500 text-sm font-semibold flex items-center gap-2 mr-4"><i class="fas fa-print"></i> ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
                    <button onclick="closeStudentProfileModal()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                </div>
            </div>
            <div id="student-profile-content" class="p-6 max-h-[70vh] overflow-y-auto"></div>
        </div>
    </div>
    <div id="book-modal" class="modal-backdrop justify-center items-center">
        <div class="modal-content bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3">
            <div class="p-6 border-b"><h3 id="book-modal-title" class="text-xl font-semibold text-gray-800"></h3></div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="book-id">
                <div><label for="book-name" class="block text-sm font-medium text-gray-700 mb-1">‡¶¨‡¶á‡ßü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label><input type="text" id="book-name" class="w-full border-gray-300 rounded-md shadow-sm"></div>
                <div><label for="book-total-pages" class="block text-sm font-medium text-gray-700 mb-1">‡¶Æ‡ßã‡¶ü ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ</label><input type="number" id="book-total-pages" class="w-full border-gray-300 rounded-md shadow-sm"></div>
                <div id="book-progress-section">
                    <label for="book-completed-pages" class="block text-sm font-medium text-gray-700 mb-1">‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ</label>
                    <input type="number" id="book-completed-pages" class="w-full border-gray-300 rounded-md shadow-sm">
                    <label for="book-progress-note" class="block text-sm font-medium text-gray-700 mb-1 mt-2">‡¶®‡ßã‡¶ü (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)</label>
                    <textarea id="book-progress-note" rows="2" class="w-full border-gray-300 rounded-md shadow-sm" placeholder="‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø‡¶∞ ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡ßá ‡¶®‡ßã‡¶ü ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea>
                </div>
                <div id="book-progress-history-section" class="pt-4 border-t">
                    <h4 class="text-sm font-semibold text-gray-600 mb-2">‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</h4>
                    <div id="progress-history-list" class="text-xs text-gray-500 max-h-24 overflow-y-auto space-y-1"></div>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-between items-center">
                <button id="delete-book-btn" onclick="deleteBook()" class="btn-danger text-white px-4 py-2 rounded-md">‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®</button>
                <div>
                    <button onclick="closeBookModal()" class="btn-secondary text-white px-4 py-2 rounded-md">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                    <button onclick="saveBook()" class="btn-primary text-white px-4 py-2 rounded-md">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£</button>
                </div>
            </div>
        </div>
    </div>
    <div id="score-modal" class="modal-backdrop justify-center items-center">
        <div class="modal-content bg-white rounded-lg shadow-xl w-11/12 md:w-1/2">
            <div class="p-6 border-b"><h3 id="score-modal-title" class="text-xl font-semibold text-gray-800">‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h3></div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="score-student-id">
                <div>
                    <label for="new-score" class="block text-sm font-medium text-gray-700 mb-1">‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ï‡ßã‡¶∞ (‡ß¶-‡ßß‡ß¶‡ß¶)</label>
                    <input type="number" id="new-score" min="0" max="100" class="w-full border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="score-change-reason" class="block text-sm font-medium text-gray-700 mb-1">‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)</label>
                    <textarea id="score-change-reason" rows="3" class="w-full border-gray-300 rounded-md shadow-sm" placeholder="‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-end gap-3">
                <button onclick="closeScoreModal()" class="btn-secondary text-white px-4 py-2 rounded-md">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                <button onclick="saveNewScore()" class="btn-primary text-white px-4 py-2 rounded-md">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- PROTOTYPE DATA ---
        const allClasses = ['‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ', '‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡¶Ø‡¶º ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ', '‡¶§‡ßÉ‡¶§‡ßÄ‡¶Ø‡¶º ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ'];
        const allStudents = [
            { id: 'ST001', name: '‡¶Ü‡¶¨‡ßç‡¶¶‡ßÅ‡¶≤‡ßç‡¶≤‡¶æ‡¶π ‡¶∞‡¶π‡¶Æ‡¶æ‡¶®', fatherName: '‡¶∞‡¶π‡¶Æ‡¶æ‡¶® ‡¶Ü‡¶π‡¶Æ‡ßá‡¶¶', rollNumber: '101', class: '‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ', mobile: '01711000001', district: '‡¶¢‡¶æ‡¶ï‡¶æ', upazila: '‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶æ' },
            { id: 'ST002', name: '‡¶Æ‡ßã‡¶π‡¶æ‡¶Æ‡ßç‡¶Æ‡¶¶ ‡¶Ü‡¶≤‡ßÄ', fatherName: '‡¶ï‡¶∞‡¶ø‡¶Æ ‡¶â‡¶¶‡ßç‡¶¶‡¶ø‡¶®', rollNumber: '102', class: '‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ', mobile: '01711000002', district: '‡¶¢‡¶æ‡¶ï‡¶æ', upazila: '‡¶ó‡ßÅ‡¶≤‡¶∂‡¶æ‡¶®' },
            { id: 'ST003', name: '‡¶π‡¶æ‡¶∏‡¶æ‡¶® ‡¶Æ‡¶æ‡¶π‡¶Æ‡ßÅ‡¶¶', fatherName: '‡¶ú‡¶æ‡¶Æ‡¶æ‡¶≤ ‡¶π‡ßã‡¶∏‡ßá‡¶®', rollNumber: '103', class: '‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ', mobile: '01711000003', district: '‡¶ï‡ßÅ‡¶Æ‡¶ø‡¶≤‡ßç‡¶≤‡¶æ', upazila: '‡¶∏‡¶¶‡¶∞' },
            { id: 'ST004', name: '‡¶´‡¶æ‡¶§‡¶ø‡¶Æ‡¶æ ‡¶ñ‡¶æ‡¶§‡ßÅ‡¶®', fatherName: '‡¶Ü‡¶ï‡¶¨‡¶∞ ‡¶Ü‡¶≤‡ßÄ', rollNumber: '201', class: '‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡¶Ø‡¶º ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ', mobile: '01811000004', district: '‡¶ö‡¶ü‡ßç‡¶ü‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ', upazila: '‡¶ï‡ßã‡¶§‡ßã‡¶Ø‡¶º‡¶æ‡¶≤‡ßÄ' },
            { id: 'ST005', name: '‡¶Ü‡¶Ø‡¶º‡ßá‡¶∂‡¶æ ‡¶∏‡¶ø‡¶¶‡ßç‡¶¶‡¶ø‡¶ï‡¶æ', fatherName: '‡¶®‡ßÇ‡¶∞ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ', rollNumber: '202', class: '‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡¶Ø‡¶º ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ', mobile: '01811000005', district: '‡¶∏‡¶ø‡¶≤‡ßá‡¶ü', upazila: '‡¶∏‡¶¶‡¶∞' },
            { id: 'ST006', name: '‡¶Ü‡¶π‡¶Æ‡¶¶ ‡¶∂‡¶∞‡ßÄ‡¶´', fatherName: '‡¶∏‡¶ø‡¶∞‡¶æ‡¶ú‡ßÅ‡¶≤ ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ', rollNumber: '301', class: '‡¶§‡ßÉ‡¶§‡ßÄ‡¶Ø‡¶º ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ', mobile: '01911000006', district: '‡¶∞‡¶æ‡¶ú‡¶∂‡¶æ‡¶π‡ßÄ', upazila: '‡¶¨‡ßã‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ' },
        ];
        let allEducationProgress = JSON.parse(localStorage.getItem('educationProgress_v4')) || [
            { id: 'B001', class: '‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ', book: '‡¶ï‡¶æ‡¶Ø‡¶º‡¶¶‡¶æ', total: 100, progressHistory: [{date: '2025-08-10T15:00:00.000Z', completed: 80}] }, 
            { id: 'B002', class: '‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ', book: '‡¶Ü‡¶Æ‡¶™‡¶æ‡¶∞‡¶æ', total: 120, progressHistory: [{date: '2025-08-12T15:00:00.000Z', completed: 45}] },
            { id: 'B003', class: '‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡¶Ø‡¶º ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ', book: '‡¶®‡¶æ‡¶ú‡ßá‡¶∞‡¶æ', total: 200, progressHistory: [{date: '2025-08-14T15:00:00.000Z', completed: 60}] }, 
            { id: 'B004', class: '‡¶§‡ßÉ‡¶§‡ßÄ‡¶Ø‡¶º ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ', book: '‡¶π‡¶ø‡¶´‡¶ú', total: 300, progressHistory: [] },
        ];
        let teachersLogbook = JSON.parse(localStorage.getItem('teachersLogbook_v3')) || {};
        let studentScores = JSON.parse(localStorage.getItem('studentScores_v3')) || {};
        let scoreChangeHistory = JSON.parse(localStorage.getItem('scoreChangeHistory_v1')) || {};
        let tarbiyahGoals = JSON.parse(localStorage.getItem('tarbiyahGoals_v1')) || {};

        // --- GLOBAL STATE ---
        let currentClass = null; let currentLogTab = 'class'; let currentStudentIdForProfile = null;
        
        // --- DOM CACHE ---
        let domCache = {};
        
        function getCachedElement(id) {
            if (!domCache[id]) {
                domCache[id] = document.getElementById(id);
            }
            return domCache[id];
        }
        
        function updateElementText(id, text) {
            const element = getCachedElement(id);
            if (element && element.textContent !== text) {
                element.textContent = text;
            }
        }
        
        function updateElementHTML(id, html) {
            const element = getCachedElement(id);
            if (element && element.innerHTML !== html) {
                element.innerHTML = html;
            }
        }
        
        // --- PERFORMANCE OPTIMIZATION ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initTeachersCorner();
            
            // Check if a class was passed as a URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const selectedClass = urlParams.get('class');
            
            if (selectedClass && allClasses.includes(selectedClass)) {
                // Automatically open the selected class dashboard
                showClassDashboard(selectedClass);
            } else {
                // If no class selected, default to first available class
                if (allClasses.length > 0) {
                    showClassDashboard(allClasses[0]);
                }
            }
        });

        function initTeachersCorner() {
            const dropdown = document.getElementById('teachers-corner-dropdown');
            dropdown.innerHTML = allClasses.map(c => `<a href="#" onclick="showClassDashboard('${c}')" class="dropdown-item">${c}</a>`).join('');
        }

        // --- NAVIGATION ---
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(sec => sec.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
        }

        function showClassDashboard(className) {
            currentClass = className;
            showSection('teachers-corner-section');
            document.getElementById('class-dashboard-title').innerText = `${className} - ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°`;
            const studentsInClass = allStudents.filter(s => s.class === className);
            renderTodaySummary(studentsInClass);
            renderClassStudentList(studentsInClass);
            renderClassEducationProgress(className);
            renderClassOverview(studentsInClass);
            renderTeachersLogbook();
            renderDashboardAlerts(studentsInClass);
        }

        // --- DATA CALCULATION ---
        function getHusnulKhulukScore(studentId) {
            if (!studentScores[studentId]) {
                studentScores[studentId] = Math.floor(Math.random() * 61) + 40;
                localStorage.setItem('studentScores_v3', JSON.stringify(studentScores));
            }
            return studentScores[studentId];
        }

        function editHusnulKhuluk(studentId, currentScore) {
            document.getElementById('score-student-id').value = studentId;
            document.getElementById('new-score').value = currentScore;
            document.getElementById('score-change-reason').value = '';
            document.getElementById('score-modal').style.display = 'flex';
        }

        function closeScoreModal() {
            document.getElementById('score-modal').style.display = 'none';
        }

        function saveNewScore() {
            const studentId = document.getElementById('score-student-id').value;
            const newScore = document.getElementById('new-score').value;
            const changeReason = document.getElementById('score-change-reason').value;
            const oldScore = studentScores[studentId] || 0;
            
            if (newScore !== null && !isNaN(newScore) && newScore >= 0 && newScore <= 100) {
                // Log the score change
                if (!scoreChangeHistory[studentId]) {
                    scoreChangeHistory[studentId] = [];
                }
                scoreChangeHistory[studentId].push({
                    date: new Date().toISOString(),
                    oldScore: oldScore,
                    newScore: parseInt(newScore),
                    reason: changeReason || '‡¶ï‡ßã‡¶® ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶â‡¶≤‡ßç‡¶≤‡ßá‡¶ñ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø',
                    changedBy: '‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï'
                });
                
                studentScores[studentId] = parseInt(newScore);
                localStorage.setItem('studentScores_v3', JSON.stringify(studentScores));
                localStorage.setItem('scoreChangeHistory_v1', JSON.stringify(scoreChangeHistory));
                
                const studentsInClass = allStudents.filter(s => s.class === currentClass);
                renderClassStudentList(studentsInClass);
                renderClassOverview(studentsInClass);
                closeScoreModal();
            } else {
                alert("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡ß¶ ‡¶•‡ßá‡¶ï‡ßá ‡ßß‡ß¶‡ß¶ ‡¶è‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®‡•§");
            }
        }

        // --- RENDERING FUNCTIONS ---
        function renderTodaySummary(students) {
            const total = students.length;
            const present = Math.floor(Math.random() * (total + 1));
            const absent = total - present;
            const rate = total > 0 ? Math.round((present / total) * 100) : 0;
            
            // Batch DOM updates
            requestAnimationFrame(() => {
                updateElementText('class-total-students', total);
                updateElementText('class-present-today', present);
                updateElementText('class-absent-today', absent);
                updateElementText('class-attendance-rate', `${rate}%`);
            });
        }
        
        function renderClassOverview(students) {
            const performance = { mustaid: 0, mutawassit: 0, mujtahid: 0 };
            students.forEach(s => {
                const score = getHusnulKhulukScore(s.id);
                if (score >= 80) performance.mustaid++;
                else if (score >= 60) performance.mutawassit++;
                else performance.mujtahid++;
            });
            
            const performanceData = [
                { label: '‡¶Æ‡ßÅ‡¶∏‡ßç‡¶§‡¶æ‡¶á‡¶¶ (ŸÖŸÖÿ™ÿßÿ≤)', value: performance.mustaid, color: 'text-green-600' },
                { label: '‡¶Æ‡ßÅ‡¶§‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∏‡¶∏‡¶ø‡¶§ (ŸÖÿ™Ÿàÿ≥ÿ∑)', value: performance.mutawassit, color: 'text-yellow-600' },
                { label: '‡¶Æ‡ßÅ‡¶ú‡¶§‡¶æ‡¶π‡¶ø‡¶¶ (ŸÖÿ¨ÿ™ŸáÿØ)', value: performance.mujtahid, color: 'text-red-600' },
            ];
            document.getElementById('performance-chart').innerHTML = performanceData.map(p => {
                const tierKey = p.label.includes('‡¶Æ‡ßÅ‡¶∏‡ßç‡¶§‡¶æ‡¶á‡¶¶') ? 'mustaid' : p.label.includes('‡¶Æ‡ßÅ‡¶§‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∏‡¶∏‡¶ø‡¶§') ? 'mutawassit' : 'mujtahid';
                return `<div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-50 cursor-pointer transition-colors" onclick="filterStudentsByTier('${tierKey}')"><span class="text-sm font-semibold ${p.color}">${p.label}</span><span class="text-sm font-bold text-gray-700">${p.value} ‡¶ú‡¶®</span></div>`;
            }).join('');
            
            const classLogs = (teachersLogbook[currentClass]?.class_logs || []).sort((a,b) => new Date(b.date) - new Date(b.date)).slice(0, 3);
            const logsHTML = classLogs.length > 0 ? classLogs.map(log => `<div class="text-xs bg-gray-50 p-2 rounded"><p class="font-semibold text-gray-700">${log.details}</p><p class="text-gray-500">${new Date(log.date).toLocaleDateString('bn-BD')} - ${log.type}</p></div>`).join('') : '<p class="text-xs text-gray-500 italic">‡¶ï‡ßã‡¶®‡ßã ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ ‡¶≤‡¶ó ‡¶®‡ßá‡¶á‡•§</p>';
            
            updateElementHTML('recent-class-logs', logsHTML);
        }


        
        function filterStudentsByTier(tier) {
            const studentsInClass = allStudents.filter(s => s.class === currentClass);
            let filteredStudents = [];
            
            switch(tier) {
                case 'mustaid':
                    filteredStudents = studentsInClass.filter(s => getHusnulKhulukScore(s.id) >= 80);
                    break;
                case 'mutawassit':
                    filteredStudents = studentsInClass.filter(s => {
                        const score = getHusnulKhulukScore(s.id);
                        return score >= 60 && score < 80;
                    });
                    break;
                case 'mujtahid':
                    filteredStudents = studentsInClass.filter(s => getHusnulKhulukScore(s.id) < 60);
                    break;
                default:
                    filteredStudents = studentsInClass;
            }
            
            // Batch DOM updates using requestAnimationFrame
            requestAnimationFrame(() => {
                renderClassStudentList(filteredStudents);
                
                // Update dashboard title to show filter
                const tierLabels = {
                    'mustaid': '‡¶Æ‡ßÅ‡¶∏‡ßç‡¶§‡¶æ‡¶á‡¶¶ (ŸÖŸÖÿ™ÿßÿ≤)',
                    'mutawassit': '‡¶Æ‡ßÅ‡¶§‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∏‡¶∏‡¶ø‡¶§ (ŸÖÿ™Ÿàÿ≥ÿ∑)',
                    'mujtahid': '‡¶Æ‡ßÅ‡¶ú‡¶§‡¶æ‡¶π‡¶ø‡¶¶ (ŸÖÿ¨ÿ™ŸáÿØ)'
                };
                
                if (tier !== 'all') {
                    const titleHTML = `
                        ${currentClass} - ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° 
                        <span class="text-lg font-normal text-gray-600">(${tierLabels[tier]} - ${filteredStudents.length} ‡¶ú‡¶®)</span>
                        <button onclick="clearStudentFilter()" class="ml-2 text-sm text-blue-600 hover:text-blue-800 underline">
                            ‡¶∏‡¶¨ ‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®
                        </button>
                    `;
                    updateElementHTML('class-dashboard-title', titleHTML);
                }
            });
        }
        
        function clearStudentFilter() {
            const studentsInClass = allStudents.filter(s => s.class === currentClass);
            
            requestAnimationFrame(() => {
                renderClassStudentList(studentsInClass);
                updateElementText('class-dashboard-title', `${currentClass} - ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°`);
            });
        }

        function renderDashboardAlerts(students) {
            const alerts = [];
            
            // Check for students with low scores
            const lowScoreStudents = students.filter(s => {
                const score = getHusnulKhulukScore(s.id);
                return score < 60;
            });
            if (lowScoreStudents.length > 0) {
                alerts.push({
                    type: 'warning',
                    icon: 'fas fa-user-times',
                    title: '‡¶®‡¶ø‡¶Æ‡ßç‡¶® ‡¶π‡ßÅ‡¶∏‡¶®‡ßÅ‡¶≤ ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶ï ‡¶∏‡ßç‡¶ï‡ßã‡¶∞',
                    message: `${lowScoreStudents.length} ‡¶ú‡¶® ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡ß¨‡ß¶ ‡¶è‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá‡•§`,
                    action: '‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®'
                });
            }
            
            // Check for students with no progress
            const classProgress = allEducationProgress.filter(p => p.class === currentClass);
            const studentsWithNoProgress = students.filter(s => {
                return !classProgress.some(p => p.progressHistory.length > 0);
            });
            if (studentsWithNoProgress.length > 0) {
                alerts.push({
                    type: 'info',
                    icon: 'fas fa-book',
                    title: '‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø ‡¶®‡ßá‡¶á',
                    message: `${studentsWithNoProgress.length} ‡¶ú‡¶® ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á‡•§`,
                    action: '‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®'
                });
            }
            
            // Check for important logs that need follow-up
            const importantLogs = [];
            students.forEach(s => {
                const studentLogs = teachersLogbook[currentClass]?.student_logs[s.id] || [];
                const important = studentLogs.filter(log => log.needsFollowup);
                importantLogs.push(...important);
            });
            if (importantLogs.length > 0) {
                alerts.push({
                    type: 'danger',
                    icon: 'fas fa-exclamation-circle',
                    title: '‡¶Ö‡¶®‡ßÅ‡¶∏‡¶∞‡¶£ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®',
                    message: `${importantLogs.length} ‡¶ü‡¶ø ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡ßã‡¶ü ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶∞‡¶£‡ßá‡¶∞ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ‡¶Ø‡¶º‡•§`,
                    action: '‡¶®‡ßã‡¶ü ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®'
                });
            }
            
            const alertsContent = document.getElementById('alerts-content');
            if (alerts.length === 0) {
                alertsContent.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ ‡¶®‡ßá‡¶á‡•§ ‡¶∏‡¶¨‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá!</p>';
            } else {
                alertsContent.innerHTML = alerts.map(alert => `
                    <div class="flex items-center justify-between p-3 rounded-lg ${alert.type === 'danger' ? 'bg-red-50 border border-red-200' : alert.type === 'warning' ? 'bg-yellow-50 border border-yellow-200' : 'bg-blue-50 border border-blue-200'}">
                        <div class="flex items-center gap-3">
                            <i class="${alert.icon} ${alert.type === 'danger' ? 'text-red-500' : alert.type === 'warning' ? 'text-yellow-500' : 'text-blue-500'}"></i>
                            <div>
                                <div class="font-semibold text-sm ${alert.type === 'danger' ? 'text-red-800' : alert.type === 'warning' ? 'text-yellow-800' : 'text-blue-800'}">${alert.title}</div>
                                <div class="text-xs ${alert.type === 'danger' ? 'text-red-600' : alert.type === 'warning' ? 'text-yellow-600' : 'text-blue-600'}">${alert.message}</div>
                            </div>
                        </div>
                        <button class="text-xs px-3 py-1 rounded ${alert.type === 'danger' ? 'bg-red-100 text-red-700 hover:bg-red-200' : alert.type === 'warning' ? 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'}">${alert.action}</button>
                    </div>
                `).join('');
            }
        }

        function renderClassStudentList(students) {
            const listEl = document.getElementById('class-student-list');
            if (students.length === 0) {
                listEl.innerHTML = `<tr><td colspan="3" class="text-center p-4">‡¶è‡¶á ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ‡¶§‡ßá ‡¶ï‡ßã‡¶® ‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶®‡ßá‡¶á‡•§</td></tr>`;
                return;
            }
            listEl.innerHTML = students.map(s => {
                const score = getHusnulKhulukScore(s.id);
                let scoreClass = 'score-attention';
                if (score >= 80) scoreClass = 'score-good';
                else if (score >= 60) scoreClass = 'score-average';
                return `<tr class="border-b hover:bg-gray-50"><td class="px-4 py-2 text-center"><span onclick="editHusnulKhuluk('${s.id}', ${score})" class="score-badge ${scoreClass}" title="‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®">${score}</span></td><td class="px-4 py-2 font-medium">${s.rollNumber}</td><td onclick="showStudentProfile('${s.id}')" class="px-4 py-2 text-blue-600 hover:underline cursor-pointer">${s.name}</td></tr>`;
            }).join('');
        }
        
        function renderClassEducationProgress(className) {
            const progressEl = document.getElementById('class-education-progress');
            const classProgress = allEducationProgress.filter(p => p.class === className);
            if(classProgress.length === 0) {
                progressEl.innerHTML = `<p class="text-sm text-gray-500">‡¶è‡¶á ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶® ‡¶¨‡¶á ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§</p>`; return;
            }
            progressEl.innerHTML = classProgress.map(p => {
                const lastProgress = p.progressHistory.length > 0 ? p.progressHistory[p.progressHistory.length - 1].completed : 0;
                const percentage = Math.round((lastProgress / p.total) * 100);
                const remaining = p.total - lastProgress;
                return `<div><div class="flex justify-between items-center mb-1"><span onclick="showBookModal('${p.id}')" class="text-sm font-medium text-gray-700 hover:text-blue-500 cursor-pointer" title="‡¶¨‡¶á ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®">${p.book}</span><span class="text-xs text-gray-500">${lastProgress}/${remaining}</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-500 h-2.5 rounded-full" style="width: ${percentage}%"></div></div></div>`;
            }).join('');
        }

        function renderTeachersLogbook() {
            const displayEl = document.getElementById('logbook-display');
            if (!teachersLogbook[currentClass]) teachersLogbook[currentClass] = { class_logs: [], student_logs: {} };
            let logsToShow = currentLogTab === 'class' ? teachersLogbook[currentClass].class_logs : Object.values(teachersLogbook[currentClass].student_logs).flat();
            logsToShow.sort((a, b) => new Date(b.date) - new Date(a.date));
            if (logsToShow.length === 0) {
                displayEl.innerHTML = `<p class="text-center text-sm text-gray-500 p-4">‡¶ï‡ßã‡¶®‡ßã ‡¶®‡ßã‡¶ü ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</p>`; return;
            }
            displayEl.innerHTML = logsToShow.map(log => {
                const student = log.studentId ? allStudents.find(s => s.id === log.studentId) : null;
                const priorityFlags = [];
                if (log.isImportant) priorityFlags.push('<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded">‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£</span>');
                if (log.needsFollowup) priorityFlags.push('<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">‡¶Ö‡¶®‡ßÅ‡¶∏‡¶∞‡¶£ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®</span>');
                
                return `<div class="log-entry bg-gray-50 p-3 rounded-md relative ${log.isImportant ? 'border-l-4 border-red-500' : ''}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="text-xs text-gray-500 mb-1">
                                <span><strong>${log.type}</strong> ${student ? `(${student.name})` : ''}</span> - <span>${new Date(log.date).toLocaleDateString('bn-BD')}</span>
                                ${priorityFlags.length > 0 ? `<div class="mt-1 flex gap-1">${priorityFlags.join('')}</div>` : ''}
                            </div>
                            <p class="text-sm text-gray-800">${log.details}</p>
                        </div>
                        <div class="log-actions flex gap-2 text-gray-500">
                            <button onclick="editLog('${log.id}')" class="hover:text-blue-500"><i class="fas fa-edit text-xs"></i></button>
                            <button onclick="deleteLog('${log.id}')" class="hover:text-red-500"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // --- LOGBOOK LOGIC (Same as before) ---
        function switchLogTab(tab) {
            currentLogTab = tab;
            document.querySelectorAll('.logbook-tabs button').forEach(b => b.classList.remove('active'));
            document.querySelector(`.logbook-tabs button[onclick="switchLogTab('${tab}')"]`).classList.add('active');
            renderTeachersLogbook();
        }
        function showAddLogModal() {
            document.getElementById('log-id').value = '';
            document.getElementById('log-modal-title').innerText = `"${currentClass}" ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡ßã‡¶ü`;
            document.getElementById('log-details').value = '';
            document.getElementById('log-type').value = '‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶Æ‡ßÇ‡¶≤‡¶ï';
            document.getElementById('log-student-id').value = '';
            document.getElementById('log-important').checked = false;
            document.getElementById('log-followup').checked = false;
            document.getElementById('log-modal').style.display = 'flex';
        }
        function closeLogModal() { document.getElementById('log-modal').style.display = 'none'; }
        function saveLogEntry() {
            const logId = document.getElementById('log-id').value;
            const className = currentClass;
            const studentId = document.getElementById('log-student-id').value;
            const type = document.getElementById('log-type').value;
            const details = document.getElementById('log-details').value;
            const isImportant = document.getElementById('log-important').checked;
            const needsFollowup = document.getElementById('log-followup').checked;
            
            if (!details.trim()) { alert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§'); return; }
            
            const logData = { 
                type, 
                details, 
                isImportant, 
                needsFollowup,
                date: new Date().toISOString() 
            };
            
            if (logId) {
                let logFound = false;
                if (studentId) {
                    const studentLogs = teachersLogbook[className].student_logs[studentId];
                    const logIndex = studentLogs.findIndex(l => l.id === logId);
                    if (logIndex > -1) { 
                        studentLogs[logIndex] = { ...studentLogs[logIndex], ...logData }; 
                        logFound = true; 
                    }
                } else {
                    const classLogs = teachersLogbook[className].class_logs;
                    const logIndex = classLogs.findIndex(l => l.id === logId);
                    if (logIndex > -1) { 
                        classLogs[logIndex] = { ...classLogs[logIndex], ...logData }; 
                        logFound = true; 
                    }
                }
            } else {
                const newLog = { id: `log_${Date.now()}`, ...logData };
                if (studentId) {
                    newLog.studentId = studentId;
                    if (!teachersLogbook[className].student_logs[studentId]) teachersLogbook[className].student_logs[studentId] = [];
                    teachersLogbook[className].student_logs[studentId].push(newLog);
                } else {
                    teachersLogbook[className].class_logs.push(newLog);
                }
            }
            localStorage.setItem('teachersLogbook_v3', JSON.stringify(teachersLogbook));
            renderTeachersLogbook();
            if(document.getElementById('student-profile-modal').style.display === 'flex') showStudentProfile(studentId || currentStudentIdForProfile);
            closeLogModal();
        }
        function editLog(logId) {
            let log, studentId;
            if (teachersLogbook[currentClass].class_logs.find(l => l.id === logId)) {
                log = teachersLogbook[currentClass].class_logs.find(l => l.id === logId);
            } else {
                for (const sId in teachersLogbook[currentClass].student_logs) {
                    const foundLog = teachersLogbook[currentClass].student_logs[sId].find(l => l.id === logId);
                    if (foundLog) { log = foundLog; studentId = sId; break; }
                }
            }
            if (!log) return;
            document.getElementById('log-id').value = log.id;
            document.getElementById('log-modal-title').innerText = '‡¶®‡ßã‡¶ü ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®';
            document.getElementById('log-type').value = log.type;
            document.getElementById('log-details').value = log.details;
            document.getElementById('log-student-id').value = studentId || '';
            document.getElementById('log-important').checked = log.isImportant || false;
            document.getElementById('log-followup').checked = log.needsFollowup || false;
            document.getElementById('log-modal').style.display = 'flex';
        }
        function deleteLog(logId) {
            if (!confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶á ‡¶®‡ßã‡¶ü‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?')) return;
            let logFound = false;
            if (teachersLogbook[currentClass].class_logs.some(l => l.id === logId)) {
                teachersLogbook[currentClass].class_logs = teachersLogbook[currentClass].class_logs.filter(l => l.id !== logId);
                logFound = true;
            } else {
                for (const sId in teachersLogbook[currentClass].student_logs) {
                    const initialLength = teachersLogbook[currentClass].student_logs[sId].length;
                    teachersLogbook[currentClass].student_logs[sId] = teachersLogbook[currentClass].student_logs[sId].filter(l => l.id !== logId);
                    if (teachersLogbook[currentClass].student_logs[sId].length < initialLength) { logFound = true; break; }
                }
            }
            if (logFound) {
                localStorage.setItem('teachersLogbook_v3', JSON.stringify(teachersLogbook));
                renderTeachersLogbook();
            }
        }
        
        // --- STUDENT PROFILE LOGIC (UNIFIED VIEW) ---
        function showStudentProfile(studentId) {
            currentStudentIdForProfile = studentId;
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;
            document.getElementById('student-profile-title').innerText = `${student.name} - ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤`;
            const score = getHusnulKhulukScore(studentId);
            const studentLogs = (teachersLogbook[student.class]?.student_logs[studentId] || []).sort((a, b) => new Date(b.date) - new Date(a.date));
            const scoreHistory = scoreChangeHistory[studentId] || [];
            
            const profileContent = `<div class="space-y-6">
                <!-- Profile Tabs -->
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8">
                        <button onclick="switchProfileTab('overview')" class="profile-tab active py-2 px-1 border-b-2 border-blue-500 text-sm font-medium text-blue-600">‡¶è‡¶ï ‡¶®‡¶ú‡¶∞‡ßá</button>
                        <button onclick="switchProfileTab('logs')" class="profile-tab py-2 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï‡ßá‡¶∞ ‡¶®‡ßã‡¶ü</button>
                        <button onclick="switchProfileTab('score-history')" class="profile-tab py-2 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</button>
                        <button onclick="switchProfileTab('tarbiyah-goals')" class="profile-tab py-2 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">‡¶§‡¶∞‡¶¨‡¶ø‡¶Ø‡¶º‡¶æ‡¶π ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø</button>
                    </nav>
                </div>
                
                <!-- Overview Tab -->
                <div id="profile-overview" class="profile-tab-content">
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-gray-700 mb-3">‡¶è‡¶ï ‡¶®‡¶ú‡¶∞‡ßá</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div><div class="text-lg font-bold text-green-600">95%</div><div class="text-xs text-gray-500">‡¶â‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø</div></div>
                            <div><div class="text-lg font-bold text-blue-600">${score}</div><div class="text-xs text-gray-500">‡¶π‡ßÅ‡¶∏‡¶®‡ßÅ‡¶≤ ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶ï</div></div>
                            <div><div class="text-lg font-bold text-purple-600">${studentLogs.length}</div><div class="text-xs text-gray-500">‡¶®‡ßã‡¶ü ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ</div></div>
                            <div><div class="text-sm font-bold text-gray-700">${student.class}</div><div class="text-xs text-gray-500">‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ</div></div>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">‡¶Æ‡ßå‡¶≤‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-600">
                            <p><strong>‡¶∞‡ßã‡¶≤:</strong> ${student.rollNumber}</p>
                            <p><strong>‡¶™‡¶ø‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ:</strong> ${student.fatherName}</p>
                            <p><strong>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</strong> ${student.mobile}</p>
                            <p><strong>‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ:</strong> ${student.upazila}, ${student.district}</p>
                        </div>
                    </div>
                </div>
                
                <!-- Logs Tab -->
                <div id="profile-logs" class="profile-tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-semibold text-gray-700">‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï‡ßá‡¶∞ ‡¶®‡ßã‡¶ü (${studentLogs.length})</h4>
                        <button onclick="showAddStudentLogModal('${student.id}')" class="btn-success text-white px-3 py-1 text-sm rounded-md flex items-center gap-1">
                            <i class="fas fa-plus"></i> ‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡ßã‡¶ü
                        </button>
                    </div>
                    <div class="space-y-3">
                        ${studentLogs.length > 0 ? studentLogs.map(log => {
                            const priorityFlags = [];
                            if (log.isImportant) priorityFlags.push('<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded">‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£</span>');
                            if (log.needsFollowup) priorityFlags.push('<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">‡¶Ö‡¶®‡ßÅ‡¶∏‡¶∞‡¶£ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®</span>');
                            
                            return `<div class="log-entry bg-gray-50 p-3 rounded-md relative ${log.isImportant ? 'border-l-4 border-red-500' : ''}">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="text-xs text-gray-500 mb-1">
                                            <span><strong>${log.type}</strong></span> - <span>${new Date(log.date).toLocaleDateString('bn-BD')}</span>
                                            ${priorityFlags.length > 0 ? `<div class="mt-1 flex gap-1">${priorityFlags.join('')}</div>` : ''}
                                        </div>
                                        <p class="text-sm text-gray-800">${log.details}</p>
                                    </div>
                                    <div class="log-actions flex gap-2 text-gray-500">
                                        <button onclick="editLog('${log.id}')" class="hover:text-blue-500"><i class="fas fa-edit text-xs"></i></button>
                                        <button onclick="deleteLog('${log.id}')" class="hover:text-red-500"><i class="fas fa-trash text-xs"></i></button>
                                    </div>
                                </div>
                            </div>`;
                        }).join('') : '<p class="text-sm text-gray-500 text-center p-4">‡¶è‡¶á ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶®‡ßã‡¶ü ‡¶®‡ßá‡¶á‡•§</p>'}
                    </div>
                </div>
                
                <!-- Score History Tab -->
                <div id="profile-score-history" class="profile-tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-semibold text-gray-700">‡¶π‡ßÅ‡¶∏‡¶®‡ßÅ‡¶≤ ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶ï ‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</h4>
                        <button onclick="editHusnulKhuluk('${student.id}', ${score})" class="btn-primary text-white px-3 py-1 text-sm rounded-md">
                            ‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
                        </button>
                    </div>
                    <div class="space-y-3">
                        ${scoreHistory.length > 0 ? scoreHistory.map(change => `
                            <div class="bg-gray-50 p-3 rounded-md">
                                <div class="flex justify-between items-center mb-2">
                                    <div class="text-sm font-medium text-gray-700">
                                        ${change.oldScore} ‚Üí ${change.newScore}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        ${new Date(change.date).toLocaleDateString('bn-BD')}
                                    </div>
                                </div>
                                <div class="text-xs text-gray-600">
                                    <strong>‡¶ï‡¶æ‡¶∞‡¶£:</strong> ${change.reason}
                                </div>
                            </div>
                        `).reverse().join('') : '<p class="text-sm text-gray-500 text-center p-4">‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßá‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶®‡ßá‡¶á‡•§</p>'}
                    </div>
                </div>
                
                <!-- Tarbiyah Goals Tab -->
                <div id="profile-tarbiyah-goals" class="profile-tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-semibold text-gray-700">‡¶§‡¶∞‡¶¨‡¶ø‡¶Ø‡¶º‡¶æ‡¶π ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø</h4>
                        <button onclick="saveTarbiyahGoals('${student.id}')" class="btn-success text-white px-3 py-1 text-sm rounded-md">
                            <i class="fas fa-save"></i> ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£
                        </button>
                    </div>
                    <div class="space-y-3">
                        ${renderTarbiyahGoalsChecklist(studentId)}
                    </div>
                </div>
            </div>`;
            document.getElementById('student-profile-content').innerHTML = profileContent;
            document.getElementById('student-profile-modal').style.display = 'flex';
        }
        function closeStudentProfileModal() { document.getElementById('student-profile-modal').style.display = 'none'; }
        
        function switchProfileTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.profile-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.profile-tab').forEach(tab => {
                tab.classList.remove('active', 'border-blue-500', 'text-blue-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(`profile-${tabName}`).classList.remove('hidden');
            
            // Add active class to selected tab
            const activeTab = document.querySelector(`[onclick="switchProfileTab('${tabName}')"]`);
            activeTab.classList.add('active', 'border-blue-500', 'text-blue-600');
            activeTab.classList.remove('border-transparent', 'text-gray-500');
        }
        function showAddStudentLogModal(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;
            closeStudentProfileModal();
            document.getElementById('log-id').value = '';
            document.getElementById('log-modal-title').innerText = `"${student.name}" ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡ßã‡¶ü`;
            document.getElementById('log-details').value = '';
            document.getElementById('log-type').value = '‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶Æ‡ßÇ‡¶≤‡¶ï';
            document.getElementById('log-student-id').value = studentId;
            document.getElementById('log-modal').style.display = 'flex';
        }

        // --- EDUCATION PROGRESS LOGIC ---
        function showBookModal(bookId = null) {
            const modal = document.getElementById('book-modal');
            const title = document.getElementById('book-modal-title');
            const deleteBtn = document.getElementById('delete-book-btn');
            const progressSection = document.getElementById('book-progress-section');
            const historySection = document.getElementById('book-progress-history-section');
            
            if (bookId) {
                const book = allEducationProgress.find(b => b.id === bookId);
                title.innerText = "‡¶¨‡¶á ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ì ‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø";
                document.getElementById('book-id').value = book.id;
                document.getElementById('book-name').value = book.book;
                document.getElementById('book-total-pages').value = book.total;
                const lastProgress = book.progressHistory.length > 0 ? book.progressHistory[book.progressHistory.length - 1].completed : 0;
                document.getElementById('book-completed-pages').value = lastProgress;
                
                const historyList = document.getElementById('progress-history-list');
                historyList.innerHTML = book.progressHistory.length > 0 ? book.progressHistory.map(h => 
                    `<li class="mb-1">
                        <div class="text-xs font-medium">${new Date(h.date).toLocaleString('bn-BD')}: ${h.completed} ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ</div>
                        ${h.note ? `<div class="text-xs text-gray-600 italic">${h.note}</div>` : ''}
                    </li>`
                ).reverse().join('') : '<li>‡¶ï‡ßã‡¶®‡ßã ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶®‡ßá‡¶á‡•§</li>';

                deleteBtn.style.display = 'block';
                progressSection.style.display = 'block';
                historySection.style.display = 'block';
            } else {
                title.innerText = "‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶á ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®";
                document.getElementById('book-id').value = '';
                document.getElementById('book-name').value = '';
                document.getElementById('book-total-pages').value = '';
                deleteBtn.style.display = 'none';
                progressSection.style.display = 'none';
                historySection.style.display = 'none';
                document.getElementById('book-progress-note').value = '';
            }
            modal.style.display = 'flex';
        }
        function closeBookModal() { document.getElementById('book-modal').style.display = 'none'; }
        function saveBook() {
            const bookId = document.getElementById('book-id').value;
            const bookName = document.getElementById('book-name').value;
            const totalPages = parseInt(document.getElementById('book-total-pages').value);
            const completedPages = parseInt(document.getElementById('book-completed-pages').value);
            const progressNote = document.getElementById('book-progress-note').value;

            if (!bookName || isNaN(totalPages) || totalPages <= 0) { alert("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®‡•§"); return; }
            
            if (bookId) { // Update
                const bookIndex = allEducationProgress.findIndex(b => b.id === bookId);
                if (bookIndex > -1) {
                    const book = allEducationProgress[bookIndex];
                    book.book = bookName;
                    book.total = totalPages;
                    const lastCompleted = book.progressHistory.length > 0 ? book.progressHistory[book.progressHistory.length - 1].completed : -1;
                    if (completedPages !== lastCompleted) {
                         if (isNaN(completedPages) || completedPages < 0 || completedPages > totalPages) {
                            alert(`‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡ß¶ ‡¶•‡ßá‡¶ï‡ßá ${totalPages} ‡¶è‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®‡•§`); return;
                         }
                         book.progressHistory.push({ 
                             date: new Date().toISOString(), 
                             completed: completedPages,
                             note: progressNote || null
                         });
                    }
                }
            } else { // Add new
                const newBook = { id: `B${Date.now()}`, class: currentClass, book: bookName, total: totalPages, progressHistory: [] };
                allEducationProgress.push(newBook);
            }
            localStorage.setItem('educationProgress_v4', JSON.stringify(allEducationProgress));
            renderClassEducationProgress(currentClass);
            closeBookModal();
        }
        function deleteBook() {
            const bookId = document.getElementById('book-id').value;
            if (confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶á ‡¶¨‡¶á‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) {
                allEducationProgress = allEducationProgress.filter(b => b.id !== bookId);
                localStorage.setItem('educationProgress_v4', JSON.stringify(allEducationProgress));
                renderClassEducationProgress(currentClass);
                closeBookModal();
            }
        }
        
        // --- PRINT FUNCTIONALITY ---
        function printStudentProfile() {
            const student = allStudents.find(s => s.id === currentStudentIdForProfile);
            if (!student) return;
            const score = getHusnulKhulukScore(student.id);
            const studentLogs = (teachersLogbook[student.class]?.student_logs[student.id] || []).sort((a,b) => new Date(b.date) - new Date(a.date));
            const classProgress = allEducationProgress.filter(p => p.class === student.class);
            const printContent = `<html><head><title>${student.name} - ‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</title><script src="https://cdn.tailwindcss.com"><\/script><style> body { font-family: 'Segoe UI', sans-serif; } @media print { .no-print { display: none; } } </style></head><body class="bg-white p-8"><div class="text-center mb-8 border-b pb-4"><h1 class="text-3xl font-bold text-gray-800">‡¶Æ‡¶æ‡¶¶‡¶æ‡¶®‡ßÄ ‡¶Æ‡¶ï‡ßç‡¶§‡¶¨</h1><p class="text-lg text-gray-600">‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶¨‡¶ø‡¶ï ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</p></div><div class="mb-6"><h2 class="text-xl font-semibold border-b-2 border-gray-300 pb-2 mb-4">‡¶Æ‡ßå‡¶≤‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø</h2><div class="grid grid-cols-2 gap-4 text-sm"><p><strong>‡¶®‡¶æ‡¶Æ:</strong> ${student.name}</p><p><strong>‡¶∞‡ßã‡¶≤:</strong> ${student.rollNumber}</p><p><strong>‡¶™‡¶ø‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ:</strong> ${student.fatherName}</p><p><strong>‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ:</strong> ${student.class}</p><p><strong>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</strong> ${student.mobile}</p><p><strong>‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ:</strong> ${student.upazila}, ${student.district}</p></div></div><div class="mb-6"><h2 class="text-xl font-semibold border-b-2 border-gray-300 pb-2 mb-4">‡¶è‡¶ï ‡¶®‡¶ú‡¶∞‡ßá</h2><div class="grid grid-cols-4 gap-4 text-center bg-gray-50 p-4 rounded-lg"><div><div class="text-2xl font-bold text-green-600">95%</div><div class="text-sm text-gray-500">‡¶â‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø</div></div><div><div class="text-2xl font-bold text-blue-600">${score}</div><div class="text-sm text-gray-500">‡¶π‡ßÅ‡¶∏‡¶®‡ßÅ‡¶≤ ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶ï</div></div><div><div class="text-2xl font-bold text-purple-600">${studentLogs.length}</div><div class="text-sm text-gray-500">‡¶®‡ßã‡¶ü ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ</div></div><div><div class="text-2xl font-bold text-yellow-600">${classProgress.length}</div><div class="text-sm text-gray-500">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶á</div></div></div></div><div class="mb-6"><h2 class="text-xl font-semibold border-b-2 border-gray-300 pb-2 mb-4">‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï‡ßá‡¶∞ ‡¶®‡ßã‡¶ü</h2><div class="space-y-3 text-sm">${studentLogs.length > 0 ? studentLogs.map(log => `<div class="p-2 border rounded-md"><p><strong>${log.type} (${new Date(log.date).toLocaleDateString('bn-BD')}):</strong> ${log.details}</p></div>`).join('') : '<p>‡¶ï‡ßã‡¶®‡ßã ‡¶®‡ßã‡¶ü ‡¶®‡ßá‡¶á‡•§</p>'}</div></div><div class="text-center text-xs text-gray-400 mt-8"><p>‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶ü‡¶ø ${new Date().toLocaleString('bn-BD')} ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§</p></div></body></html>`;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
        }

        // --- TARBIYAH GOALS FUNCTIONS ---
        function renderTarbiyahGoalsChecklist(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return '';
            
            // Initialize goals for this student if they don't exist
            if (!tarbiyahGoals[studentId]) {
                tarbiyahGoals[studentId] = {
                    helpingClassmates: false,
                    punctuality: false,
                    respectForTeachers: false,
                    cleanliness: false,
                    prayerPunctuality: false,
                    memorizationEffort: false,
                    helpingAtHome: false,
                    goodBehavior: false
                };
                localStorage.setItem('tarbiyahGoals_v1', JSON.stringify(tarbiyahGoals));
            }
            
            const goals = tarbiyahGoals[studentId];
            const goalDefinitions = {
                helpingClassmates: '‡¶∏‡¶π‡¶™‡¶æ‡¶†‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶æ',
                punctuality: '‡¶∏‡¶Æ‡¶Ø‡¶º‡¶æ‡¶®‡ßÅ‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§‡¶æ',
                respectForTeachers: '‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï‡¶¶‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶∂‡ßç‡¶∞‡¶¶‡ßç‡¶ß‡¶æ',
                cleanliness: '‡¶™‡¶∞‡¶ø‡¶ö‡ßç‡¶õ‡¶®‡ßç‡¶®‡¶§‡¶æ',
                prayerPunctuality: '‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º‡¶æ‡¶®‡ßÅ‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§‡¶æ',
                memorizationEffort: '‡¶π‡¶ø‡¶´‡¶ú‡ßá‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ',
                helpingAtHome: '‡¶¨‡¶æ‡¶°‡¶º‡¶ø‡¶§‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶æ',
                goodBehavior: '‡¶≠‡¶æ‡¶≤‡ßã ‡¶Ü‡¶ö‡¶∞‡¶£'
            };
            
            return Object.entries(goals).map(([key, checked]) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-md">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" 
                               id="goal-${key}-${studentId}" 
                               ${checked ? 'checked' : ''} 
                               onchange="updateTarbiyahGoal('${studentId}', '${key}', this.checked)"
                               class="rounded text-blue-600 focus:ring-blue-500">
                        <span class="text-sm font-medium text-gray-700">${goalDefinitions[key]}</span>
                    </label>
                    <div class="text-xs text-gray-500">
                        ${checked ? '<span class="text-green-600">‚úì ‡¶Ö‡¶∞‡ßç‡¶ú‡¶ø‡¶§</span>' : '<span class="text-gray-400">‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®</span>'}
                    </div>
                </div>
            `).join('');
        }
        
        function updateTarbiyahGoal(studentId, goalKey, isChecked) {
            if (!tarbiyahGoals[studentId]) {
                tarbiyahGoals[studentId] = {};
            }
            tarbiyahGoals[studentId][goalKey] = isChecked;
            localStorage.setItem('tarbiyahGoals_v1', JSON.stringify(tarbiyahGoals));
        }
        
        function saveTarbiyahGoals(studentId) {
            // Goals are already saved automatically when checkboxes change
            // This function can be used for additional validation or feedback
            alert('‡¶§‡¶∞‡¶¨‡¶ø‡¶Ø‡¶º‡¶æ‡¶π ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
        }

    </script>
</body>
</html>
