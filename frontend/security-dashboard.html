<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Dashboard - Madani Maktab</title>
    <link href="style.css" rel="stylesheet" type="text/css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/3.3.0/tailwind.min.js"></script>
    <style>
        .security-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .locked-ip {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        .attempt-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        .refresh-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        .stat-label {
            color: #666;
            font-size: 1.1em;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">
                <i class="fas fa-shield-alt text-blue-600"></i>
                Security Dashboard
            </h1>
            <p class="text-gray-600 text-lg">Monitor login attempts and security statistics</p>
        </div>

        <div class="text-center mb-6">
            <button onclick="refreshStats()" class="refresh-btn">
                <i class="fas fa-sync-alt"></i> Refresh Statistics
            </button>
            <p class="text-sm text-gray-500 mt-2">Last updated: <span id="lastUpdated">Never</span></p>
        </div>

        <!-- Statistics Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <i class="fas fa-users text-3xl text-blue-500 mb-3"></i>
                <div class="stat-number" id="totalTrackedIPs">-</div>
                <div class="stat-label">Tracked IP Addresses</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-lock text-3xl text-red-500 mb-3"></i>
                <div class="stat-number" id="currentlyLockedIPs">-</div>
                <div class="stat-label">Currently Locked IPs</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-clock text-3xl text-orange-500 mb-3"></i>
                <div class="stat-number" id="lockoutDuration">15</div>
                <div class="stat-label">Lockout Duration (minutes)</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-hourglass text-3xl text-purple-500 mb-3"></i>
                <div class="stat-number" id="sessionTimeout">60</div>
                <div class="stat-label">Session Timeout (minutes)</div>
            </div>
        </div>

        <!-- Currently Locked IPs -->
        <div class="security-card">
            <h2 class="text-2xl font-bold mb-4">
                <i class="fas fa-lock"></i> Currently Locked IP Addresses
            </h2>
            <div id="lockedIPsList">
                <p class="text-center text-lg">Loading...</p>
            </div>
        </div>

        <!-- Active Failed Attempts -->
        <div class="security-card">
            <h2 class="text-2xl font-bold mb-4">
                <i class="fas fa-exclamation-triangle"></i> Active Failed Login Attempts
            </h2>
            <div id="activeAttemptsList">
                <p class="text-center text-lg">Loading...</p>
            </div>
        </div>

        <!-- Security Log -->
        <div class="security-card">
            <h2 class="text-2xl font-bold mb-4">
                <i class="fas fa-list-alt"></i> Recent Security Events
            </h2>
            <div id="securityLog">
                <p class="text-center text-lg">Loading...</p>
            </div>
        </div>
    </div>

    <script>
        let securityStats = null;
        let refreshInterval = null;

        // Check authentication on page load
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/user');
                if (!response.ok) {
                    window.location.href = '/login.html';
                    return;
                }
                
                const user = await response.json();
                if (user.role !== 'admin') {
                    alert('Access denied. Admin privileges required.');
                    window.location.href = '/';
                    return;
                }
                
                // Start auto-refresh
                startAutoRefresh();
                
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/login.html';
            }
        }

        // Fetch security statistics
        async function fetchSecurityStats() {
            try {
                const response = await fetch('/api/auth/security-stats');
                if (!response.ok) {
                    throw new Error('Failed to fetch security stats');
                }
                
                securityStats = await response.json();
                updateDashboard();
                updateLastUpdated();
                
            } catch (error) {
                console.error('Failed to fetch security stats:', error);
                document.getElementById('lockedIPsList').innerHTML = 
                    '<p class="text-center text-lg text-red-300">Failed to load security statistics</p>';
                document.getElementById('activeAttemptsList').innerHTML = 
                    '<p class="text-center text-center text-lg text-red-300">Failed to load security statistics</p>';
            }
        }

        // Update dashboard with security statistics
        function updateDashboard() {
            if (!securityStats) return;

            // Update statistics
            document.getElementById('totalTrackedIPs').textContent = securityStats.total_tracked_ips;
            document.getElementById('currentlyLockedIPs').textContent = securityStats.currently_locked_ips;
            document.getElementById('lockoutDuration').textContent = securityStats.lockout_duration_minutes;
            document.getElementById('sessionTimeout').textContent = securityStats.session_timeout_minutes;

            // Update locked IPs list
            const lockedIPsList = document.getElementById('lockedIPsList');
            if (securityStats.locked_ips.length === 0) {
                lockedIPsList.innerHTML = '<p class="text-center text-lg text-green-300">No IPs currently locked</p>';
            } else {
                lockedIPsList.innerHTML = securityStats.locked_ips.map(ip => `
                    <div class="locked-ip">
                        <div class="flex justify-between items-center">
                            <div>
                                <strong>IP Address:</strong> ${ip.ip}<br>
                                <strong>Failed Attempts:</strong> ${ip.attempts}<br>
                                <strong>Locked Until:</strong> ${ip.locked_until}<br>
                                <strong>Remaining Lockout:</strong> ${Math.floor(ip.remaining_lockout / 60)}m ${ip.remaining_lockout % 60}s
                            </div>
                            <div class="text-right">
                                <i class="fas fa-lock text-2xl"></i>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Update active attempts list
            const activeAttemptsList = document.getElementById('activeAttemptsList');
            const activeIPs = Object.keys(securityStats.active_attempts);
            
            if (activeIPs.length === 0) {
                activeAttemptsList.innerHTML = '<p class="text-center text-lg text-green-300">No failed login attempts recorded</p>';
            } else {
                activeAttemptsList.innerHTML = activeIPs.map(ip => {
                    const data = securityStats.active_attempts[ip];
                    return `
                        <div class="attempt-card">
                            <div class="flex justify-between items-center">
                                <div>
                                    <strong>IP Address:</strong> ${ip}<br>
                                    <strong>Failed Attempts:</strong> ${data.count}/${securityStats.max_attempts}<br>
                                    <strong>First Attempt:</strong> ${data.first_attempt}<br>
                                    <strong>Last Attempt:</strong> ${data.last_attempt}
                                </div>
                                <div class="text-right">
                                    <i class="fas fa-exclamation-triangle text-2xl"></i>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Update security log
            updateSecurityLog();
        }

        // Update security log with recent events
        function updateSecurityLog() {
            const securityLog = document.getElementById('securityLog');
            const currentTime = new Date().toLocaleString();
            
            let logEntries = [
                `[${currentTime}] Dashboard refreshed - ${securityStats.total_tracked_ips} IPs tracked`,
                `[${currentTime}] ${securityStats.currently_locked_ips} IPs currently locked out`,
                `[${currentTime}] Security threshold: ${securityStats.max_attempts} failed attempts = ${securityStats.lockout_duration_minutes} minute lockout`
            ];

            securityLog.innerHTML = logEntries.map(entry => 
                `<div class="bg-white bg-opacity-20 p-3 rounded-lg mb-2">${entry}</div>`
            ).join('');
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            const now = new Date().toLocaleString();
            document.getElementById('lastUpdated').textContent = now;
        }

        // Refresh statistics
        function refreshStats() {
            fetchSecurityStats();
        }

        // Start auto-refresh every 30 seconds
        function startAutoRefresh() {
            refreshInterval = setInterval(fetchSecurityStats, 30000);
        }

        // Stop auto-refresh
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // Initialize dashboard
        async function initDashboard() {
            await checkAuth();
            await fetchSecurityStats();
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', stopAutoRefresh);

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
