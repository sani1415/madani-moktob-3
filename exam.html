<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Results Prototype - Madani Maktab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, 'Noto Sans Bengali', sans-serif; background-color: #f5f5f5; }
        .header { background: linear-gradient(135deg, #2c3e50, #3498db); }
        .nav { background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .section h2 { color: #2c3e50; border-bottom: 3px solid #3498db; }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 200; animation: fadeIn 0.3s; }
        .modal-content { animation: slideIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .results-table input { text-align: center; border: 1px solid #ccc; border-radius: 4px; width: 60px; padding: 4px; }
        .results-table input:focus { outline: 2px solid #3498db; }
        .rank-badge { font-size: 1.1em; font-weight: bold; padding: 2px 8px; border-radius: 4px; color: white; }
        .rank-1 { background-color: #f1c40f; } .rank-2 { background-color: #bdc3c7; } .rank-3 { background-color: #d35400; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header & Navigation -->
    <header class="header text-white p-5 shadow-md">
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold"><i class="fas fa-graduation-cap"></i> মাদানী মক্তব</h1>
        </div>
    </header>
    <nav class="nav">
        <div class="container mx-auto">
            <ul class="flex justify-center items-center list-none">
                <li><a href="#" onclick="showSection('main-dashboard')" class="nav-link block px-6 py-4 text-gray-600 hover:text-blue-500">ড্যাশবোর্ড</a></li>
                <li><a href="#" onclick="showSection('exam-results-section')" class="nav-link block px-6 py-4 text-gray-600 hover:text-blue-500 font-semibold"><i class="fas fa-poll"></i> পরীক্ষার ফলাফল</a></li>
                <li><a href="#" class="nav-link block px-6 py-4 text-gray-600 hover:text-blue-500">ছাত্র নিবন্ধন</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto p-4 md:p-6">
        <section id="main-dashboard" class="section">
            <h2 class="text-2xl font-bold mb-6 pb-2">মূল ড্যাশবোর্ড</h2>
            <div class="bg-white p-8 rounded-lg shadow-md text-center text-gray-600">
                <p>"পরীক্ষার ফলাফল" ট্যাবে যান এবং ফলাফল পরিচালনা শুরু করুন।</p>
            </div>
        </section>

        <section id="exam-results-section" class="section hidden">
            <h2 class="text-2xl font-bold mb-6 pb-2">পরীক্ষার ফলাফল ব্যবস্থাপনা</h2>

            <!-- Control Panel -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                    <div>
                        <label for="exam-year" class="block text-sm font-medium text-gray-700 mb-1">শিক্ষাবর্ষ</label>
                        <select id="exam-year" class="w-full border-gray-300 rounded-md shadow-sm"></select>
                    </div>
                    <div>
                        <label for="exam-term" class="block text-sm font-medium text-gray-700 mb-1">টার্ম/সেমিস্টার</label>
                        <select id="exam-term" class="w-full border-gray-300 rounded-md shadow-sm"></select>
                    </div>
                    <div>
                        <label for="exam-class" class="block text-sm font-medium text-gray-700 mb-1">শ্রেণী</label>
                        <select id="exam-class" class="w-full border-gray-300 rounded-md shadow-sm" onchange="populateBookSelector()"></select>
                    </div>
                    <button onclick="loadResultsView()" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300 flex items-center justify-center gap-2">
                        <i class="fas fa-arrow-down"></i> টেবিল লোড করুন
                    </button>
                </div>
                <div id="book-selector-container" class="mt-6 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">পরীক্ষার বই নির্বাচন করুন</label>
                    <div id="exam-book-list" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
                </div>
            </div>

            <!-- Results View (hidden by default) -->
            <div id="results-view" class="hidden space-y-8">
                <!-- Analytics Dashboard -->
                <div id="analytics-summary" class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700 flex items-center gap-2"><i class="fas fa-chart-line text-purple-500"></i> শ্রেণীর পারফরম্যান্স বিশ্লেষণ</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div id="subject-analytics" class="space-y-4"></div>
                        <div>
                            <h4 class="font-semibold text-gray-600 text-center mb-2">গ্রেড বিতরণ</h4>
                            <canvas id="grade-distribution-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Results Table -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-700">ফলাফল টেবিল</h3>
                        <button onclick="openImportModal()" class="bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition duration-300 flex items-center gap-2 text-sm">
                            <i class="fas fa-file-csv"></i> CSV ইম্পোর্ট করুন
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-600 results-table">
                            <thead id="results-table-head" class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0"></thead>
                            <tbody id="results-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Modals -->
    <div id="import-modal" class="modal-backdrop justify-center items-center">
        <div class="modal-content bg-white rounded-lg shadow-xl w-11/12 md:w-2/3">
            <div class="p-6 border-b flex justify-between items-center"><h3 class="text-xl font-semibold text-gray-800">CSV থেকে ফলাফল ইম্পোর্ট করুন</h3><button onclick="closeImportModal()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div>
            <div class="p-6 space-y-4">
                <div>
                    <label for="csv-file" class="block text-sm font-medium text-gray-700 mb-1">CSV ফাইল</label>
                    <input type="file" id="csv-file" accept=".csv" class="w-full border-gray-300 rounded-md">
                </div>
                <button onclick="previewImport()" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700">প্রিভিউ দেখুন</button>
                <div id="import-preview-area" class="hidden mt-4">
                    <h4 class="font-semibold mb-2">ইম্পোর্ট প্রিভিউ</h4>
                    <p id="import-validation-summary" class="text-sm mb-2 p-2 rounded-md"></p>
                    <div id="import-preview-table" class="max-h-60 overflow-auto border rounded-md"></div>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-end gap-3">
                <button onclick="closeImportModal()" class="bg-gray-600 text-white px-4 py-2 rounded-md">বাতিল</button>
                <button id="finalize-import-btn" onclick="finalizeImport()" class="bg-green-600 text-white px-4 py-2 rounded-md disabled:bg-gray-400" disabled>ইম্পোর্ট চূড়ান্ত করুন</button>
            </div>
        </div>
    </div>

    <div id="student-results-modal" class="modal-backdrop justify-center items-center">
        <div class="modal-content bg-white rounded-lg shadow-xl w-11/12 md:w-2/3">
            <div class="p-6 border-b flex justify-between items-center"><h3 id="student-modal-title" class="text-xl font-semibold text-gray-800"></h3><button onclick="closeStudentModal()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div>
            <div id="student-modal-body" class="p-6"></div>
        </div>
    </div>

    <script>
        // --- IN-MEMORY DATA STORE ---
        const allStudents = [
            { id: 'ST001', name: 'আব্দুল্লাহ রহমান', roll: '101', class: 'প্রথম শ্রেণী' },
            { id: 'ST002', name: 'মোহাম্মদ আলী', roll: '102', class: 'প্রথম শ্রেণী' },
            { id: 'ST003', name: 'হাসান মাহমুদ', roll: '103', class: 'প্রথম শ্রেণী' },
            { id: 'ST004', name: 'ফাতিমা খাতুন', roll: '201', class: 'দ্বিতীয় শ্রেণী' },
            { id: 'ST005', name: 'আয়েশা সিদ্দিকা', roll: '202', class: 'দ্বিতীয় শ্রেণী' },
        ];
        const allBooks = [
            { id: 'B01', name: 'কায়দা', class: 'প্রথম শ্রেণী', totalMarks: 100 },
            { id: 'B02', name: 'আমপারা', class: 'প্রথম শ্রেণী', totalMarks: 100 },
            { id: 'B03', name: 'আখলাক', class: 'প্রথম শ্রেণী', totalMarks: 50 },
            { id: 'B04', name: 'নাজেরা', class: 'দ্বিতীয় শ্রেণী', totalMarks: 100 },
            { id: 'B05', name: 'মাসনুন দোয়া', class: 'দ্বিতীয় শ্রেণী', totalMarks: 50 },
        ];
        let examResults = {}; // { '2025-Term 1-প্রথম শ্রেণী': { 'ST001': { 'B01': 85, 'B02': 92 }, ... } }
        let gradeChart = null;
        let importPreviewData = [];

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            populateControls();
            showSection('main-dashboard');
        });

        function populateControls() {
            const yearSelect = document.getElementById('exam-year');
            const termSelect = document.getElementById('exam-term');
            const classSelect = document.getElementById('exam-class');
            
            // Populate Year
            const currentYear = new Date().getFullYear();
            for (let i = currentYear + 1; i >= currentYear - 2; i--) {
                yearSelect.innerHTML += `<option value="${i}">${i}</option>`;
            }
            // Populate Term
            ['Term 1', 'Term 2'].forEach(term => termSelect.innerHTML += `<option value="${term}">${term}</option>`);
            // Populate Class
            [...new Set(allStudents.map(s => s.class))].forEach(c => classSelect.innerHTML += `<option value="${c}">${c}</option>`);
            
            populateBookSelector();
        }

        function populateBookSelector() {
            const selectedClass = document.getElementById('exam-class').value;
            const booksForClass = allBooks.filter(b => b.class === selectedClass);
            const bookListDiv = document.getElementById('exam-book-list');
            
            bookListDiv.innerHTML = booksForClass.map(book => `
                <label class="flex items-center space-x-2 text-sm">
                    <input type="checkbox" class="form-checkbox h-4 w-4 rounded text-blue-600" value="${book.id}">
                    <span>${book.name}</span>
                </label>
            `).join('');
            document.getElementById('book-selector-container').classList.remove('hidden');
        }
        
        // --- CORE LOGIC ---
        function getSessionKey() {
            const year = document.getElementById('exam-year').value;
            const term = document.getElementById('exam-term').value;
            const className = document.getElementById('exam-class').value;
            return `${year}-${term}-${className}`;
        }
        
        function getSelectedBookIds() {
            return Array.from(document.querySelectorAll('#exam-book-list input:checked')).map(cb => cb.value);
        }

        function loadResultsView() {
            const selectedBookIds = getSelectedBookIds();
            if (selectedBookIds.length === 0) {
                alert("অনুগ্রহ করে কমপক্ষে একটি বই নির্বাচন করুন।");
                return;
            }
            document.getElementById('results-view').classList.remove('hidden');
            renderResultsTable();
        }

        function renderResultsTable() {
            const sessionKey = getSessionKey();
            const selectedBookIds = getSelectedBookIds();
            const selectedClass = document.getElementById('exam-class').value;
            const studentsInClass = allStudents.filter(s => s.class === selectedClass);
            const booksInExam = allBooks.filter(b => selectedBookIds.includes(b.id));

            // Initialize results for session if not present
            if (!examResults[sessionKey]) examResults[sessionKey] = {};

            // Render Table Head
            const tableHead = document.getElementById('results-table-head');
            let headHTML = '<tr><th class="px-4 py-3">ছাত্রের নাম</th><th class="px-4 py-3">রোল</th>';
            booksInExam.forEach(book => headHTML += `<th class="px-4 py-3 text-center">${book.name}<br><small>(${book.totalMarks})</small></th>`);
            headHTML += '<th class="px-4 py-3 text-center">মোট</th><th class="px-4 py-3 text-center">%</th><th class="px-4 py-3 text-center">গ্রেড</th><th class="px-4 py-3 text-center">র‍্যাঙ্ক</th></tr>';
            tableHead.innerHTML = headHTML;

            // Calculate Ranks
            const studentRanks = calculateClassRanks(sessionKey, selectedBookIds);

            // Render Table Body
            const tableBody = document.getElementById('results-table-body');
            tableBody.innerHTML = studentsInClass.map(student => {
                const studentResults = examResults[sessionKey][student.id] || {};
                const { total, percentage, grade } = calculateStudentTotals(student.id, sessionKey, selectedBookIds);
                const rank = studentRanks[student.id];
                
                let rowHTML = `<tr class="border-b"><td class="px-4 py-2 font-medium text-blue-600 hover:underline cursor-pointer" onclick="showStudentResults('${student.id}')">${student.name}</td><td class="px-4 py-2">${student.roll}</td>`;
                booksInExam.forEach(book => {
                    const mark = studentResults[book.id] || '';
                    const colorClass = getMarkColor(mark, book.totalMarks);
                    rowHTML += `<td class="px-4 py-2 ${colorClass}"><input type="number" value="${mark}" oninput="updateMark('${student.id}', '${book.id}', this.value)"></td>`;
                });
                rowHTML += `<td class="px-4 py-2 text-center font-semibold" id="total-${student.id}">${total}</td>`;
                rowHTML += `<td class="px-4 py-2 text-center font-semibold" id="perc-${student.id}">${percentage}%</td>`;
                rowHTML += `<td class="px-4 py-2 text-center font-bold" id="grade-${student.id}">${grade}</td>`;
                rowHTML += `<td class="px-4 py-2 text-center" id="rank-${student.id}">${getRankHTML(rank)}</td></tr>`;
                return rowHTML;
            }).join('');
            
            updateAnalytics();
        }

        function updateMark(studentId, bookId, value) {
            const sessionKey = getSessionKey();
            const mark = value === '' ? null : parseInt(value);
            
            if (!examResults[sessionKey][studentId]) examResults[sessionKey][studentId] = {};
            examResults[sessionKey][studentId][bookId] = mark;

            // Recalculate and update totals for this student
            const { total, percentage, grade } = calculateStudentTotals(studentId, sessionKey, getSelectedBookIds());
            document.getElementById(`total-${studentId}`).innerText = total;
            document.getElementById(`perc-${studentId}`).innerText = `${percentage}%`;
            document.getElementById(`grade-${studentId}`).innerText = grade;
            
            // Recalculate ranks for the whole class and update
            const studentRanks = calculateClassRanks(sessionKey, getSelectedBookIds());
            Object.keys(studentRanks).forEach(sId => {
                document.getElementById(`rank-${sId}`).innerHTML = getRankHTML(studentRanks[sId]);
            });

            // Update cell color
            const book = allBooks.find(b => b.id === bookId);
            const inputElement = event.target;
            inputElement.parentElement.className = `px-4 py-2 ${getMarkColor(mark, book.totalMarks)}`;
            
            updateAnalytics();
        }

        // --- CALCULATIONS & ANALYTICS ---
        const getGrade = (p) => {
            if (p >= 80) return 'A+'; if (p >= 70) return 'A'; if (p >= 60) return 'A-';
            if (p >= 50) return 'B'; if (p >= 40) return 'C'; if (p >= 33) return 'D'; return 'F';
        };

        function calculateStudentTotals(studentId, sessionKey, bookIds) {
            const studentResults = examResults[sessionKey]?.[studentId] || {};
            let totalObtained = 0;
            let totalMarks = 0;
            bookIds.forEach(bookId => {
                const book = allBooks.find(b => b.id === bookId);
                totalMarks += book.totalMarks;
                totalObtained += studentResults[bookId] || 0;
            });
            const percentage = totalMarks > 0 ? Math.round((totalObtained / totalMarks) * 100) : 0;
            const grade = getGrade(percentage);
            return { total: totalObtained, percentage, grade };
        }

        function calculateClassRanks(sessionKey, bookIds) {
            const selectedClass = document.getElementById('exam-class').value;
            const studentsInClass = allStudents.filter(s => s.class === selectedClass);
            const studentTotals = studentsInClass.map(student => ({
                id: student.id,
                total: calculateStudentTotals(student.id, sessionKey, bookIds).total
            }));
            studentTotals.sort((a, b) => b.total - a.total);
            const ranks = {};
            let rank = 1;
            for (let i = 0; i < studentTotals.length; i++) {
                if (i > 0 && studentTotals[i].total < studentTotals[i - 1].total) {
                    rank = i + 1;
                }
                ranks[studentTotals[i].id] = rank;
            }
            return ranks;
        }

        function updateAnalytics() {
            const sessionKey = getSessionKey();
            const selectedBookIds = getSelectedBookIds();
            const selectedClass = document.getElementById('exam-class').value;
            const studentsInClass = allStudents.filter(s => s.class === selectedClass);
            const booksInExam = allBooks.filter(b => selectedBookIds.includes(b.id));
            
            // Subject Analytics
            const subjectAnalyticsDiv = document.getElementById('subject-analytics');
            subjectAnalyticsDiv.innerHTML = booksInExam.map(book => {
                const marks = studentsInClass.map(s => examResults[sessionKey]?.[s.id]?.[book.id]).filter(m => m != null);
                const average = marks.length > 0 ? (marks.reduce((a, b) => a + b, 0) / marks.length).toFixed(2) : 'N/A';
                const highest = marks.length > 0 ? Math.max(...marks) : 'N/A';
                const lowest = marks.length > 0 ? Math.min(...marks) : 'N/A';
                return `
                    <div>
                        <h4 class="font-semibold text-gray-600">${book.name}</h4>
                        <div class="grid grid-cols-3 gap-2 text-center text-sm mt-2">
                            <div class="bg-blue-50 p-2 rounded-md"><div class="font-bold text-blue-700">${average}</div><div class="text-xs text-blue-600">গড়</div></div>
                            <div class="bg-green-50 p-2 rounded-md"><div class="font-bold text-green-700">${highest}</div><div class="text-xs text-green-600">সর্বোচ্চ</div></div>
                            <div class="bg-red-50 p-2 rounded-md"><div class="font-bold text-red-700">${lowest}</div><div class="text-xs text-red-600">সর্বনিম্ন</div></div>
                        </div>
                    </div>
                `;
            }).join('');

            // Grade Distribution
            const gradeCounts = { 'A+': 0, 'A': 0, 'A-': 0, 'B': 0, 'C': 0, 'D': 0, 'F': 0 };
            studentsInClass.forEach(student => {
                const { grade } = calculateStudentTotals(student.id, sessionKey, selectedBookIds);
                gradeCounts[grade]++;
            });
            
            const ctx = document.getElementById('grade-distribution-chart').getContext('2d');
            if (gradeChart) gradeChart.destroy();
            gradeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(gradeCounts),
                    datasets: [{
                        label: 'ছাত্র সংখ্যা',
                        data: Object.values(gradeCounts),
                        backgroundColor: ['#27ae60', '#2980b9', '#8e44ad', '#f39c12', '#d35400', '#c0392b', '#e74c3c'],
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }
        
        // --- UI HELPERS ---
        const getMarkColor = (m, t) => {
            if (m === null || m === '') return '';
            const p = (m / t) * 100;
            if (p >= 80) return 'bg-green-100'; if (p >= 60) return 'bg-blue-100';
            if (p >= 40) return 'bg-yellow-100'; return 'bg-red-100';
        };
        const getRankHTML = (r) => {
            if (!r) return '-';
            if (r <= 3) return `<span class="rank-badge rank-${r}">${r}</span>`;
            return r;
        };
        const showSection = (id) => {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        };

        // --- MODAL LOGIC ---
        function openImportModal() { document.getElementById('import-modal').style.display = 'flex'; }
        function closeImportModal() { document.getElementById('import-modal').style.display = 'none'; }
        function showStudentResults(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            const sessionKey = getSessionKey();
            const selectedBookIds = getSelectedBookIds();
            const booksInExam = allBooks.filter(b => selectedBookIds.includes(b.id));
            const studentResults = examResults[sessionKey]?.[studentId] || {};
            const { total, percentage, grade } = calculateStudentTotals(studentId, sessionKey, selectedBookIds);
            const rank = calculateClassRanks(sessionKey, selectedBookIds)[studentId];

            document.getElementById('student-modal-title').innerText = `${student.name} - ফলাফল`;
            const body = document.getElementById('student-modal-body');
            body.innerHTML = `
                <div class="grid grid-cols-4 gap-4 text-center bg-gray-50 p-4 rounded-lg mb-6">
                    <div><div class="text-2xl font-bold text-gray-800">${total}</div><div class="text-sm text-gray-500">মোট নম্বর</div></div>
                    <div><div class="text-2xl font-bold text-blue-600">${percentage}%</div><div class="text-sm text-gray-500">শতাংশ</div></div>
                    <div><div class="text-2xl font-bold text-green-600">${grade}</div><div class="text-sm text-gray-500">গ্রেড</div></div>
                    <div><div class="text-2xl font-bold text-purple-600">${getRankHTML(rank)}</div><div class="text-sm text-gray-500">র‍্যাঙ্ক</div></div>
                </div>
                <table class="w-full text-sm">
                    <thead class="bg-gray-100"><tr><th class="p-2">বই</th><th class="p-2">প্রাপ্ত নম্বর</th><th class="p-2">মোট নম্বর</th><th class="p-2">শতাংশ</th></tr></thead>
                    <tbody>
                        ${booksInExam.map(book => {
                            const mark = studentResults[book.id] || 0;
                            const perc = Math.round((mark / book.totalMarks) * 100);
                            return `<tr class="border-b"><td class="p-2">${book.name}</td><td class="p-2">${mark}</td><td class="p-2">${book.totalMarks}</td><td class="p-2">${perc}%</td></tr>`;
                        }).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('student-results-modal').style.display = 'flex';
        }
        function closeStudentModal() { document.getElementById('student-results-modal').style.display = 'none'; }
        
        // --- CSV IMPORT LOGIC ---
        function previewImport() {
            const file = document.getElementById('csv-file').files[0];
            if (!file) { alert("Please select a file."); return; }

            const reader = new FileReader();
            reader.onload = function(event) {
                const csv = event.target.result;
                const lines = csv.split('\n').map(l => l.trim()).filter(l => l);
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                const rollIndex = headers.indexOf('roll');
                
                if (rollIndex === -1) { alert("CSV must contain a 'roll' column."); return; }

                const selectedClass = document.getElementById('exam-class').value;
                const studentsInClass = allStudents.filter(s => s.class === selectedClass);
                importPreviewData = [];
                let validCount = 0, notFoundCount = 0;

                let previewHTML = '<table class="w-full text-xs"><thead><tr class="bg-gray-200">';
                headers.forEach(h => previewHTML += `<th class="p-1">${h}</th>`);
                previewHTML += '</tr></thead><tbody>';

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    const roll = values[rollIndex].trim();
                    const student = studentsInClass.find(s => s.roll === roll);
                    
                    const rowData = {};
                    headers.forEach((h, idx) => rowData[h] = values[idx]?.trim());

                    if (student) {
                        validCount++;
                        previewHTML += `<tr class="bg-green-50">`;
                        importPreviewData.push({ status: 'valid', data: rowData });
                    } else {
                        notFoundCount++;
                        previewHTML += `<tr class="bg-red-50">`;
                        importPreviewData.push({ status: 'invalid', data: rowData });
                    }
                    values.forEach(v => previewHTML += `<td class="p-1 border">${v}</td>`);
                    previewHTML += '</tr>';
                }
                previewHTML += '</tbody></table>';

                const summaryDiv = document.getElementById('import-validation-summary');
                summaryDiv.innerHTML = `<strong>${validCount}</strong> টি সারি বৈধ। <strong>${notFoundCount}</strong> টি ছাত্র পাওয়া যায়নি।`;
                summaryDiv.className = notFoundCount > 0 ? 'text-sm mb-2 p-2 rounded-md bg-yellow-100 text-yellow-800' : 'text-sm mb-2 p-2 rounded-md bg-green-100 text-green-800';
                
                document.getElementById('import-preview-table').innerHTML = previewHTML;
                document.getElementById('import-preview-area').classList.remove('hidden');
                document.getElementById('finalize-import-btn').disabled = validCount === 0;
            };
            reader.readAsText(file);
        }

        function finalizeImport() {
            const sessionKey = getSessionKey();
            const validEntries = importPreviewData.filter(item => item.status === 'valid');
            const booksInDb = allBooks.map(b => ({ id: b.id, name: b.name.toLowerCase() }));

            validEntries.forEach(entry => {
                const student = allStudents.find(s => s.roll === entry.data.roll);
                if (!student) return;

                if (!examResults[sessionKey][student.id]) examResults[sessionKey][student.id] = {};
                
                Object.keys(entry.data).forEach(header => {
                    const book = booksInDb.find(b => b.name === header);
                    if (book) {
                        const mark = parseInt(entry.data[header]);
                        if (!isNaN(mark)) {
                            examResults[sessionKey][student.id][book.id] = mark;
                        }
                    }
                });
            });
            
            alert(`${validEntries.length} জন ছাত্রের ফলাফল সফলভাবে ইম্পোর্ট করা হয়েছে।`);
            closeImportModal();
            renderResultsTable();
        }

    </script>
</body>
</html>

